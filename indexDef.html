<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Add a geocoder</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css" type="text/css"/>
<link rel="stylesheet" href="./css/appESA_01.css" type="text/css"/>
<!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
</head>
<body>
    <nav id="menu"></nav>
    <div id="map"></div>
    <pre id="features"></pre>
    <script>
        // Style //////////////////////
	    var map = new mapboxgl.Map({
            container: 'map',
            style: 'https://geoserveis.icgc.cat/contextmaps/hibrid.json', 
            center: [1.5, 41.6],
            zoom: 8
            });
        // Style //////////////////////
        // Search //////////////////////
        map.addControl(
            new MapboxGeocoder({
            accessToken: 'pk.eyJ1IjoidG9uaWxvZ2FyIiwiYSI6ImNqY3VkMnVmazB2bm0yd283aXBxZDV5d3gifQ.bbqgWxCfhrZVG-IgOPyQ8g',
            mapboxgl: mapboxgl
            })
            );
        // Search //////////////////////
        // Create map //////////////////////
        map.on('load', function() {
            ////////////////// Green points //////////////////////////////////////
            var greenTiles=map.addSource("no_detected_pointsGreen", {
                "type": "vector",
                "url": "http://localhost:8081/data/no_detected_pointsGreen.json",
                "maxzoom": 7
            });       
            var greenLayer=map.addLayer({
                "id": "Green",
                "source": "no_detected_pointsGreen",
                "source-layer": "no_detected_pointsGreen",
                "type": "circle",
                "layout": {
                "visibility": "visible"
                },
                "paint": {
                    "circle-radius": 4,
                    "circle-color": "green"
                }
            });
            ////////////////// Green points //////////////////////////////////////
            ////////////////// Blue points //////////////////////////////////////
            map.addSource("outDef", {
                "type": "vector",
                "tiles": ["https://tilemaps.icgc.cat/tileserver/tileserver.php/pousCat/{z}/{x}/{y}.pbf"],
                "maxzoom": 7
            });
        
            map.addLayer({
                "id": "Blue",
                "source": "outDef",
                "source-layer": "in",
                "type": "circle",
                "layout": {
                "visibility": "visible"
                },
                "paint": {
                    "circle-opacity": 1,
                    "circle-color": "#3413ba",
                    "circle-stroke-color": "#7fb872"
                }
            });
            ////////////////// Blue points //////////////////////////////////////
            ////////////////// Red points //////////////////////////////////////
            map.addSource("detected_pointsRed", {
                "type": "vector",
                "url": "http://localhost:8081/data/detected_pointsRed.json",
                "maxzoom": 7
            });
            map.addLayer({
                "id": "Red",
                "source": "detected_pointsRed",
                "source-layer": "detected_pointsRed",
                "type": "circle",
                "layout": {
                "visibility": "visible"
                },
                "paint": {
                    "circle-radius": 4,
                    "circle-color": "red"
                }
            });
            ////////////////// Red points //////////////////////////////////////  
        });
        // Create map //////////////////////

        // Controls navigation (zoom, rotation) /////////////
        map.addControl(new mapboxgl.NavigationControl());

        // Geolocate ////////////////////////////////////
            map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
            enableHighAccuracy: true
            },
            trackUserLocation: true
        }));

        // Disable enable layers //////////    
        // Enumerate ids of the layers ////////// 
        var toggleableLayerIds = ['Green', 'Blue', 'Red'];

        // Set up the corresponding toggle button for each layer ////////// 
        for (var i = 0; i < toggleableLayerIds.length; i++) {
            var id = toggleableLayerIds[i];

            var link = document.createElement('a');
            link.href = '#';
            link.className = 'active';
            link.textContent = id;

            link.onclick = function (e) {
                var clickedLayer = this.textContent;
                e.preventDefault();
                e.stopPropagation();

                var visibility = map.getLayoutProperty(clickedLayer, 'visibility');

                // Toggle layer visibility by changing the layout object's visibility property ////////// 
                if (visibility === 'visible') {
                    map.setLayoutProperty(clickedLayer, 'visibility', 'none');
                    this.className = '';
                } else {
                    this.className = 'active';
                    map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
                }
            };

            var layers = document.getElementById('menu');
            layers.appendChild(link);
        }
        // Disable enable layers //////////  
        // Show metadata points //////////  
        map.on('mousemove', function (e) {
            var features = map.queryRenderedFeatures(e.point);
 
        // Limit the number of properties we're displaying for ////////// 
        // Legibility and performance ////////// 
        var displayProperties = [
            'properties'
        ];
 
        var displayFeatures = features.map(function (feat) {
            var displayFeat = {};
            displayProperties.forEach(function (prop) {
                displayFeat[prop] = feat[prop];
            });
            return displayFeat;
        });
 
        document.getElementById('features').innerHTML = JSON.stringify(
            displayFeatures,
            null,
            2
        );
    });
    // Show metadata points //////////  
</script>
 
</body>
</html>