<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Add a geocoder</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css" type="text/css"/>
<link rel="stylesheet" href="./css/appESACambrils_01.css" type="text/css"/>
<!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<!--Load the AJAX API-->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
    <nav id="menu"></nav>
    <div id="map"></div>
    <pre id="features"></pre>
    
        <div id="container_chart_div">
            <div id="title_chart_div">
                <div id="close_chart" onclick="closeX()">X</div>
            </div>
            <div id="chart_div"></div>
        </div>
   
    <script> 
        var vel="";
        var coherence="";
        var code="";    
        // Style //////////////////////
	    var map = new mapboxgl.Map({
            container: 'map',
            style: 'https://geoserveis.icgc.cat/contextmaps/hibrid.json', 
            center: [1.050, 41.125],
            zoom: 10
            });
        // Style //////////////////////
        /*  map.addControl(new mapboxgl.FullscreenControl()); */
        // Search //////////////////////
        map.addControl(
            new MapboxGeocoder({
            accessToken: 'pk.eyJ1IjoidG9uaWxvZ2FyIiwiYSI6ImNqY3VkMnVmazB2bm0yd283aXBxZDV5d3gifQ.bbqgWxCfhrZVG-IgOPyQ8g',
            mapboxgl: mapboxgl
            })
            );
        // Search //////////////////////
        // Create map //////////////////////
        map.on('load', function() {
            ////////////////// Green points //////////////////////////////////////
            map.addSource("VERDE_punts_no_aquifer", {
                "type": "vector",
                "tiles": ["https://tilemaps.icgc.cat/tileserver/tileserver.php/VERDE_punts_no_aquifer/{z}/{x}/{y}.pbf"],
                "maxzoom": 7
            });       
            map.addLayer({
                "id": "Non aquifer motion points",
                "source": "VERDE_punts_no_aquifer",
                "source-layer": "VERDE_punts_no_aquifer",
                "type": "circle",
                "layout": {
                "visibility": "visible"
                },
                "paint": {
                    "circle-radius": 6,
                    "circle-color": "green"
                }
            });
            ////////////////// Green points //////////////////////////////////////
            ////////////////// Blue points //////////////////////////////////////
            ////////////////// Blue points //////////////////////////////////////
            map.addSource("outDef", {
                "type": "vector",
                "tiles": ["https://tilemaps.icgc.cat/tileserver/tileserver.php/pousCat/{z}/{x}/{y}.pbf"],
                "maxzoom": 7
            });
        
            map.addLayer({
                "id": "Declared wells",
                "source": "outDef",
                "source-layer": "in",
                "type": "circle",
                "layout": {
                "visibility": "visible"
                },
                "paint": {
                    "circle-radius": 3,
                    "circle-color": "blue"
                }
            });
            ////////////////// Blue points //////////////////////////////////////
            ////////////////// Red points //////////////////////////////////////
            var rojoSource=map.addSource("ROJO_punts_aquifer_detectats", {
                "type": "vector",
                "tiles": ["https://tilemaps.icgc.cat/tileserver/tileserver.php/ROJO_punts_aquifer_detectats/{z}/{x}/{y}.pbf"],
                "maxzoom": 7
            });
            var rojoLayer=map.addLayer({
                "id": "Aquifer motion points",
                "source": "ROJO_punts_aquifer_detectats",
                "source-layer": "ROJO_punts_aquifer_detectats",
                "type": "circle",
                "layout": {
                "visibility": "visible"
                },
                "paint": {
                    "circle-radius": 6,
                    "circle-color": "red"
                }
            });
            ////////////////// Red points //////////////////////////////////////
        });      
        // Create map //////////////////////

        // Controls navigation (zoom, rotation) /////////////
        map.addControl(new mapboxgl.NavigationControl());

        // Geolocate ////////////////////////////////////
            map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
            enableHighAccuracy: true
            },
            trackUserLocation: true
        }));

        // Disable enable layers //////////    
        // Enumerate ids of the layers ////////// 
        var toggleableLayerIds = ['Non aquifer motion points', 'Declared wells', 'Aquifer motion points'];

        // Set up the corresponding toggle button for each layer ////////// 
        for (var i = 0; i < toggleableLayerIds.length; i++) {
            var id = toggleableLayerIds[i];

            var link = document.createElement('a');
            link.href = '#';
            link.className = 'active';
            link.textContent = id;

            link.onclick = function (e) {
                var clickedLayer = this.textContent;
                e.preventDefault();
                e.stopPropagation();

                var visibility = map.getLayoutProperty(clickedLayer, 'visibility');

                // Toggle layer visibility by changing the layout object's visibility property ////////// 
                if (visibility === 'visible') {
                    map.setLayoutProperty(clickedLayer, 'visibility', 'none');
                    this.className = '';
                } else {
                    this.className = 'active';
                    map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
                }
            };

            var layers = document.getElementById('menu');
            layers.appendChild(link);
        }
        // Disable enable layers //////////  

        // Show metadata points //////////  
        map.on('click', function (e) {
            var features = map.queryRenderedFeatures(e.point);
            
            // Limit the number of properties we're displaying for ////////// 
            // Legibility and performance ////////// 
            var displayProperties = [           
            /*  'UTM_X',    
            'type',
            'id',
            'layer',
            'source',
            'sourceLayer',
            'state', */
            "properties"                 
            ];
             var displayFeatures = features.map(function (feat) {
                var displayFeat = {};
                displayProperties.forEach(function (prop) {
                displayFeat[prop] = feat[prop];
                });
                return displayFeat;
            });
 
            var dataFeatures=document.getElementById('features').innerHTML = JSON.stringify(
                displayFeatures,
                null,
                2
            );
            /* features.forEach(element => console.log(element + "element"));
            for (var i = 0; i < features.length; i++) {
                console.log(features + "element");

            } */
        
            // Get dates of properties       
            var dataProperties=JSON.parse(dataFeatures);

            code= dataProperties[0].properties.CODE;
            coherence= dataProperties[0].properties.AUTOCORR;      
            vel= dataProperties[0].properties.VEL; 
        
        
            
        
            var displacementValues = [];
            console.log(code + "pepe");
            
            console.log(coherence);
            console.log(vel);
            console.log(dataProperties.length + "  typeof");

            /* console.log(features[0].properties[1]CODE + "super") ; */
            var jsonPunto = JSON.stringify(features);
            console.log( jsonPunto +"   datos json punto")
        

        

            // Call googleCghart ////////
            if (code!=null){ 
                document.getElementById('container_chart_div').style.display="block";      
                google.charts.setOnLoadCallback(drawChart);
        }
    });
    // Show metadata points ////////// 
    // Close graphic window ////////// 
    function closeX(){
        document.getElementById('container_chart_div').style.display="none";
    }
    // Close graphic window ////////// 
    // Add google chart  //////////
    // Load the Visualization API and the corechart package.
    google.charts.load('current', {'packages':['corechart']});

    

    // Callback that creates and populates a data table,
    // instantiates the pie chart, passes in the data and
    // draws it.
    function drawChart() {
        // Create the data table.
        var data = new google.visualization.DataTable();
        data.addColumn('string', /* 'Topping' */);
        data.addColumn('number'/* , 'DesplaÃ§ament' */);
        data.addRows([

            ['', 0.15889716486200001],['', 0.40283864421],['', 0.6338940884520000],['', 0.84453165208100001],['', 1.02763655559],['', 1.1788437193000001],['',  1.29264188122],['', 1.36015399082],
            ['', 1.37351576657],['', 1.32918865159],['', 0.75549323967100002],['', 0.59679569578799996],['', 0.46779412498599998],['', 0.38398317066100002],['', 0.35310524370899998],['', 0.419178382357],
            ['', 0.46438220165400002],['', 0.48084064554200001],['',  0.44808999779399999],['', 0.36380405305199998],['', 0.22946340877099999],['', 0.049871986934499998],['', -0.170124953085],['', -0.42618575279600002],['', -0.71443258834300005],['', -1.03141329905],
            ['', -1.373516435990000],['', -1.73612575565],['', -2.1123068198300001],['', -2.4894222045099998],['', -2.8544992799200002],['', -3.1956186471099999],['', -3.4996713260400001],['', -3.7502593851600001],['', -3.9325096888100002],['', -4.0368137720800004],
            ['', -4.0617115336299996],['', -4.0243824217900004],['', -3.9391418147400001],['', -3.8069249493599],['', -3.236],['', -3.6264239068799999],['',  -3.4003879554899998],['', -3.1470925338],['', -2.89871638337],['', -2.68768851993],
            ['', -2.5409319294700001],['', -2.47180393371],['', -2.4787518514100002],['', -2.5691975120500001],['', -2.75132037894],['', -3.00242967913],['', -3.2914529478399999],['', -3.8794568303500001],['', -4.1235424086699997],['', -4.3052544830099997],
            
        ]);
        var espacio ="\xa0\xa0\xa0\xa0\xa0\xa0\xa0";
        var espacioData ="\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0";
        
        // Set chart options
        valorsGraficaH = [ -6, -4, -2, 0, 2];
        var options = {'title': "id: " + code +espacio+ "vel: " + vel +espacio+   "coherence: " + coherence ,
            lineWidth: 0,
            pointSize: 8,
            pointShape: 'square',
            vAxis: {
                /* title: '[mm]', */
                ticks: valorsGraficaH
            },
            hAxis: {
                title: 'from 2016 to 2019',			   
                titleFontSize: 15 
            }   
        };
  
        // Instantiate and draw our chart, passing in some options.
        var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
            chart.draw(data, options);
}
    // Add google chart  //////////

</script>
 
</body>
</html>